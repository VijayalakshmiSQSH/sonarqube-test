name: SonarQube Scan

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Run SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2.0.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Get email recipient
        id: email
        run: |
        
          COMMIT_EMAIL="${{ github.event.head_commit.author.email }}"
          
          # Check if it's a noreply address or empty
          if [[ "$COMMIT_EMAIL" == *"noreply.github.com"* ]] || [[ -z "$COMMIT_EMAIL" ]]; then
            echo "Detected noreply or empty email: $COMMIT_EMAIL"
            
            # For PR events, try to get the PR author's email
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              echo "recipient=${{ secrets.DEFAULT_EMAIL }}" >> $GITHUB_OUTPUT
              echo "recipient_name=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
            else
              # For push events, use default email
              echo "recipient=${{ secrets.DEFAULT_EMAIL }}" >> $GITHUB_OUTPUT
              echo "recipient_name=${{ github.actor }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "Using commit author email: $COMMIT_EMAIL"
            echo "recipient=$COMMIT_EMAIL" >> $GITHUB_OUTPUT
            echo "recipient_name=${{ github.event.head_commit.author.name }}" >> $GITHUB_OUTPUT
          fi
          
          # Get the actor who triggered this workflow
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "triggered_by=${{ github.triggering_actor }}" >> $GITHUB_OUTPUT

      - name: Send mail (Sonar result)
        if: always() && steps.email.outputs.recipient != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          from: "SonarQube Alerts <${{ secrets.MAIL_FROM }}>"
          to: ${{ steps.email.outputs.recipient }}
          cc: ${{ secrets.MAIL_CC }}

          subject: >
            ${{ job.status == 'success'
                && '✅ SonarQube PASSED'
                || '❌ SonarQube FAILED' }}
            | ${{ github.repository }} | ${{ github.ref_name }}

          body: |
            Hello ${{ steps.email.outputs.recipient_name }},
            
            SonarQube scan completed for your recent code changes.
            
            Repository : ${{ github.repository }}
            Branch     : ${{ github.ref_name }}
            Commit     : ${{ github.sha }}
            Status     : ${{ job.status }}
            Triggered by : ${{ steps.email.outputs.triggered_by }}
            Event type : ${{ github.event_name }}
            
            SonarQube Dashboard:
            ${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ secrets.PROJECT_KEY }}
            
            ---
            This is an automated message from SonarQube CI/CD pipeline.

