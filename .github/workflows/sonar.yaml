name: SonarQube Scan

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Run SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2.0.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Get email recipient
        if: always()
        id: email
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Helper function to check for noreply
          is_noreply() {
            [[ "$1" == *"noreply.github.com"* ]] || [[ -z "$1" ]] || [[ "$1" == "null" ]]
          }

          # 1. Start with the commit author email
          FINAL_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "Commit email: $FINAL_EMAIL"

          if is_noreply "$FINAL_EMAIL"; then
            echo "Commit email is noreply/empty. Searching for better address..."
            
            # 2. Try the pusher email (from event payload)
            PUSHER_EMAIL="${{ github.event.pusher.email }}"
            echo "Pusher email from payload: $PUSHER_EMAIL"
            
            if ! is_noreply "$PUSHER_EMAIL"; then
              FINAL_EMAIL="$PUSHER_EMAIL"
              echo "Using pusher email."
            else
              # 3. Try GitHub API to get the actor's public email
              ACTOR="${{ github.actor }}"
              echo "Fetching public email for actor: $ACTOR"
              
              API_EMAIL=$(gh api users/$ACTOR --jq '.email' 2>/dev/null || echo "")
              echo "API email: $API_EMAIL"
              
              if [[ -n "$API_EMAIL" && "$API_EMAIL" != "null" ]]; then
                FINAL_EMAIL="$API_EMAIL"
                echo "Using API email."
              else
                 echo "No public email found for $ACTOR. Trying to get email from PR commits..."
                 # 4. Try to get email from PR commits if this is a PR or merge
                 # Note: This is a best effort.
                 if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                   PR_NUM="${{ github.event.pull_request.number }}"
                   echo "Checking commits in PR #$PR_NUM"
                   # Get the author email of the last commit in the PR
                   PR_EMAIL=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM/commits --jq '.[-1].commit.author.email' 2>/dev/null || echo "")
                   if ! is_noreply "$PR_EMAIL"; then
                      FINAL_EMAIL="$PR_EMAIL"
                      echo "Found email in PR commit: $FINAL_EMAIL"
                   fi
                 fi
              fi
            fi
          fi
          
          # Final check: If still noreply, we can't send email.
          if is_noreply "$FINAL_EMAIL"; then
            echo "::warning::Could not resolve a real email address. Recipient is $FINAL_EMAIL. Email delivery may fail if using SES Sandbox."
          fi

          echo "Resolved recipient: $FINAL_EMAIL"
          echo "recipient=$FINAL_EMAIL" >> $GITHUB_OUTPUT

      - name: Send mail (Sonar result)
        if: always() && steps.email.outputs.recipient != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          from: "SonarQube Alerts <${{ secrets.MAIL_FROM }}>"
          to: ${{ steps.email.outputs.recipient }}
          cc: ${{ secrets.MAIL_CC }}

          subject: >
            ${{ job.status == 'success'
                && '✅ SonarQube PASSED'
                || '❌ SonarQube FAILED' }}
            | ${{ github.repository }} | ${{ github.ref_name }}

          body: |
            Hello,
            
            SonarQube scan completed for your recent code changes.
            
            Repository : ${{ github.repository }}
            Branch     : ${{ github.ref_name }}
            Commit     : ${{ github.sha }}
            Status     : ${{ job.status }}
            
            SonarQube Dashboard:
            ${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ secrets.PROJECT_KEY }}
            
            ---
            This is an automated message from SonarQube CI/CD pipeline.

