name: SonarQube Scan

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  sonar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Run SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2.0.2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Get email recipient
        id: email
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_EMAIL: ${{ secrets.DEFAULT_EMAIL }}
        run: |
          ACTOR="${{ github.actor }}"
          echo "Resolving details for Actor: $ACTOR"
          
          # Initialize variables
          FINAL_EMAIL=""
          FINAL_NAME=""
          TRIGGERED_BY="$ACTOR"

          # Function to validate email
          validate_email() {
            [[ -n "$1" ]] && [[ "$1" != "null" ]] && [[ "$1" != *"noreply.github.com"* ]]
          }

          # --- 1. Try API (Best for Real Name & Public Email) ---
          # We fetch both 'email' and 'name' from the profile
          USER_DATA=$(gh api "users/$ACTOR" 2>/dev/null || echo "{}")
          
          API_EMAIL=$(echo "$USER_DATA" | jq -r '.email // empty')
          API_NAME=$(echo "$USER_DATA" | jq -r '.name // empty')
          
          if validate_email "$API_EMAIL"; then
             FINAL_EMAIL="$API_EMAIL"
          fi
          
          if [[ -n "$API_NAME" && "$API_NAME" != "null" ]]; then
             FINAL_NAME="$API_NAME"
          fi

          # --- 2. Try Git History (Backup for Email & Name) ---
          if [[ -z "$FINAL_EMAIL" ]] || [[ -z "$FINAL_NAME" ]]; then
            echo "Searching Git history..."
            # Get latest log entry by this author that isn't noreply
            LOG_ENTRY=$(git log --author="$ACTOR" -n 100 --pretty=format:'%an|%ae' | grep -v 'noreply.github.com' | head -n 1)
            
            HISTORY_NAME=$(echo "$LOG_ENTRY" | cut -d'|' -f1)
            HISTORY_EMAIL=$(echo "$LOG_ENTRY" | cut -d'|' -f2)

            # If we still lack email, use history
            if [[ -z "$FINAL_EMAIL" ]] && validate_email "$HISTORY_EMAIL"; then
               FINAL_EMAIL="$HISTORY_EMAIL"
            fi
            
            # If we still lack name, use history name
            if [[ -z "$FINAL_NAME" ]] && [[ -n "$HISTORY_NAME" ]]; then
               FINAL_NAME="$HISTORY_NAME"
            fi
          fi

          # --- 3. Fallbacks ---
          # If name is still empty, fallback to Username
          if [[ -z "$FINAL_NAME" ]]; then
             FINAL_NAME="$ACTOR"
          fi
          
          # If email is still empty, use Default
          if [[ -z "$FINAL_EMAIL" ]]; then
             FINAL_EMAIL="$DEFAULT_EMAIL"
          fi

          # Set Outputs
          echo "recipient=$FINAL_EMAIL" >> $GITHUB_OUTPUT
          echo "recipient_name=$FINAL_NAME" >> $GITHUB_OUTPUT
          echo "triggered_by=$TRIGGERED_BY" >> $GITHUB_OUTPUT
          
          echo "✅ Resolved: $FINAL_NAME <$FINAL_EMAIL>"

      - name: Send mail (Sonar result)
        if: always() && steps.email.outputs.recipient != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          from: "SonarQube Alerts <${{ secrets.MAIL_FROM }}>"
          to: ${{ steps.email.outputs.recipient }}
          cc: ${{ secrets.MAIL_CC }}

          subject: >
            ${{ job.status == 'success'
                && '✅ SonarQube PASSED'
                || '❌ SonarQube FAILED' }}
            | ${{ github.repository }} | ${{ github.ref_name }}

          # Your EXACT Requested Body Format
          body: |
            Hello ${{ steps.email.outputs.recipient_name }},
            
            SonarQube scan completed for your recent code changes.
            
            Repository : ${{ github.repository }}
            Branch     : ${{ github.ref_name }}
            Commit     : ${{ github.sha }}
            Status     : ${{ job.status }}
            Triggered by : ${{ steps.email.outputs.triggered_by }}
            Event type : ${{ github.event_name }}
            
            SonarQube Dashboard:
            ${{ secrets.SONAR_HOST_URL }}/dashboard?id=${{ secrets.PROJECT_KEY }}
            
            ---
            This is an automated message from SonarQube CI/CD pipeline.
